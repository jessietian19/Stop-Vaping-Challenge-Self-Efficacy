---
title: "StopVaping_SelfConfidence_2025-07-14_tosend"
date: "2025-07-14"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
library(rms)
library(lattice)
library(dplyr)
library(tidyr)
library(survival)
library(ggplot2)
library(skimr)
library(naniar)
library(survival)
library(survminer)
library(lubridate)
library(mice)
library(gtsummary)
library(dplyr)

require("knitr")
```

```{r}

setwd("~/Desktop/OTRU/Quit Vaping App ")
stopvape <- read_csv("unimputed_dataset_allages.csv", col_names = TRUE)

stopvape.dd <- datadist(stopvape)
options(datadist="stopvape.dd")

stopvape_complete <- na.omit(stopvape)
sum(is.na(stopvape_complete))


#Complete cases 
nrow(stopvape[!complete.cases(stopvape), ])/nrow(stopvape)*100
#Incomplete cases 17.82%
stopvape_comp <- stopvape[complete.cases(stopvape),]
# df_comp$wave <- NULL
#n=5,288, p=37



```


ecusv_3: Confidence in quitting vaping within next month on a scale of 1-10
ecu17_1: Intention to quit at baseline (0= yes, but within next 6 months or beyond 6 months, 1= within next month,)
ecusv_2: Past-year quit attempts (0= no, 1=yes)
mhealth1_1: Perceived mental heath status (0= fair or poor, 1= good, very good, or excellent)

# prepare data
```{r}
# Convert categorical variables to a factor with proper labels

stopvape$gender_adj <- factor(stopvape$gender,
                            levels = c(0, 1, 2),
                            labels = c("Men", "Women", "Others"))
stopvape$sexorient_adj <- factor(stopvape$sexorient,
                               levels = c(0, 1, 2),
                               labels = c("Heterosexual", "LGBTQ", "Asexual/Undisclosed"))

stopvape <- stopvape %>%
  mutate(age = ifelse(nchar(as.character(age)) > 3, NA, age))
# str(stopvape)
# describe(stopvape)

summary(stopvape$age)
```

# Descriptive table
```{r}

#split into groups low, medium, high quitting confidence 
stopvape$conf_group <- cut(stopvape$ecusv_3,
                           breaks = c(0, 5, 10),
                           labels = c("Low", "High"),
                           right = TRUE)

# Get descriptive statistics for unique user IDs only
stopvape %>%
  distinct(userid, .keep_all = TRUE) %>%  # Keep only unique userids
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n}  ({p}%)"
    )
  )
#######################################################################################
# Filter to unique user IDs, create confidence groups, and get descriptive statistics
#######################################################################################
stopvape %>%
  distinct(userid, .keep_all = TRUE) %>%  # Keep only unique userids
  mutate(conf_group = cut(ecusv_3,
                         breaks = c(0, 5, 10),
                         labels = c("Low", "High"),
                         right = TRUE)) %>%
  tbl_summary(
    by = conf_group,  # Group by confidence level
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  add_p() %>%        # Add p-values for group comparisons
  add_overall()      # Add overall column

# # Select specific variables and create descriptive statistics
# stopvape %>%
#   distinct(userid, .keep_all = TRUE) %>%  # Keep only unique userids
#   select(age,gender,sexorient,status, Time.elapsed, ecu17_1, ecusv_2, ecusv_3, , mhealth1_1) %>%  # Select specific variables
#   tbl_summary(
#     statistic = list(
#       all_continuous() ~ "{mean} ({sd})",
#       all_categorical() ~ "{n} ({p}%)"
#     )
#   )

# Select specific variables and group by confidence
stopvape %>%
  distinct(userid, .keep_all = TRUE) %>%
  mutate(conf_group = cut(ecusv_3,
                         breaks = c(0, 5, 10),
                         labels = c("Low", "High"),
                         right = TRUE)) %>%
  select(age,gender,sexorient,race,status, Time.elapsed, ecu17_1, ecusv_2, ecusv_3, mhealth1_1, conf_group) %>%
  tbl_summary(
    by = conf_group,
    statistic = list(
      all_continuous() ~ "{median} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  add_p() %>%
  add_overall()

tbl_summary(stopvape,by=conf_group, statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)")
      )
# tbl_summary(stopvape, by = conf_group,
#             statistic = list(
#               all_continuous() ~ "{mean} ({sd})",
#               all_categorical() ~ "{n}/ {N}({p}%)")
#             ) %>%
#   add_p()%>%
#   add_overall()
# 
# tbl_summary(stopvape,by=gender)
# stopvape %>% 
#   select(ecusv_3,ecu17_1,ecusv_2, mhealth1_1) %>%  # keep only the columns of interest
#   tbl_summary()                                                # default


# # # Calculate statistics using unique user_id
# stopvape %>%
#   group_by(userid) %>%
#   summarise(
#     status = n(),  # Count records per user (assuming each record = 1 attempt)
#     .groups = 'drop'
#   ) %>%
#   summarise(
#     # Average number of quit attempts per participant
#     avg_quit_attempts = mean(status),
# 
#     # Number of participants with only one challenge
#     participants_one_challenge = sum(avg_quit_attempts == 1),
# 
#     # Maximum number of challenges completed
#     max_challenges = max(avg_quit_attempts))

# Calculate statistics using unique user_id
quit_stats <- stopvape %>%
  group_by(userid) %>%
  summarise(
    quit_attempts = n(),  # Count records per user (each record = 1 attempt)
    .groups = 'drop'
  )

# Calculate final statistics
final_stats <- quit_stats %>%
  summarise(
    # Average number of quit attempts per participant
    avg_quit_attempts = mean(quit_attempts),
    # Number of participants with only one challenge
    participants_one_challenge = sum(quit_attempts == 1),
    # Maximum number of challenges completed
    max_challenges = max(quit_attempts)
  )

# Display results
print(final_stats)


# Count how many times each userid appears (number of challenges per user)
user_challenge_counts <- table(stopvape$userid)

# Convert to a dataframe for easier analysis
user_summary <- data.frame(
  userid = names(user_challenge_counts),
  num_challenges = as.numeric(user_challenge_counts)
)

# Calculate summary statistics
results <- list(
  # Average number of challenges per participant
  avg_challenges = mean(user_summary$num_challenges),
  
  # How many participants only completed one challenge
  single_challenge_users = sum(user_summary$num_challenges == 1),
  
  # Maximum number of challenges completed by any user
  max_challenges = max(user_summary$num_challenges),
  
  # Total number of unique users
  total_users = length(unique(stopvape$userid))
)
# Display results
cat("=== USER CHALLENGE ANALYSIS ===\n")
cat("Average challenges per participant:", round(results$avg_challenges, 2), "\n")
cat("Participants with only 1 challenge:", results$single_challenge_users, "\n")
cat("Maximum challenges by one participant:", results$max_challenges, "\n")
cat("Total unique participants:", results$total_users, "\n\n")


```

# Missing data and multiple imputations (pattern of missingness)
```{r}

skim(stopvape)
summary(stopvape, na.rm = TRUE) 

# Explore patterns of missing data
# naclus clusters missingness patterns
na.pat <- naclus(stopvape[,-1])
naplot(na.pat)

vis_miss(stopvape) #display entire dataset to find missing, if sort by time, can see if time dependent missingness throughout study
gg_miss_var(stopvape) # give number misisng sorted
gg_miss_var(stopvape, show_pct = TRUE) # shown as percentage
gg_miss_case(stopvape)

gg_miss_upset(stopvape) # see what is missing when other variables are missing
n_var_miss(stopvape) #max number missing is 23 variables

ggplot(
  data = stopvape,
  mapping = aes(x = Time.elapsed, y = ecusv_3)) +     
  geom_miss_point()

stopvape$age[stopvape$age== 5198023886] <- NA

### Generate 5 imputed data sets

(v <- names(stopvape)[c(14, 32, 33, 43, 44, 42, 12, 13, 28, 40, 41)])

# md.pattern(stopvape[,v], rotate.names = TRUE)

set.seed(3098) 
stopvape.mice <- mice(stopvape[,v], method = "cart") # large number of unbalanced factor variables, use cart method 
stopvape.mice$method
plot(stopvape.mice)

densityplot(stopvape.mice) # for continuous variables
densityplot(stopvape.mice, ~ ecusv_3|.imp) #look at self-confidence by imputation


```

# Run Cox proportional hazard model for unadjusted, adjusted, and gender*self-confidence interaction on pooled imputated data
```{r}

# return all imputed datasets combined into one big data frame
stopvape.pooled <- complete(stopvape.mice, method = "long") 

fit1 <- coxph(surv_elapsed~ecusv_3,cluster(stopvape.pooled$userid),data=stopvape.pooled)
fit2 <- coxph(surv_elapsed~ecusv_3+age+country+gender_adj+sexorient_adj+race+ecu17_1+ecusv_2+mhealth1_1,cluster(stopvape.pooled$userid),data=stopvape.pooled)
fit3 <- coxph(surv_elapsed~ecusv_3*gender_adj,cluster(stopvape.pooled$userid),data=stopvape.pooled)

fitdemo <- coxph(surv_elapsed~ecusv_3+age+country+gender_adj+sexorient_adj+race,cluster(stopvape.pooled$userid),data=stopvape.pooled)

#95% CI
exp(confint(fit1))
exp(confint(fit2))
exp(confint(fit3))
exp(confint(fitdemo))

#Run AIC to compare predictive performance of models
AIC(fit1)
AIC(fit2)
AIC(fit3)
AIC(fitdemo)

#Stratified cox model by gender across imputations
# men unadjusted 
cox_mi_men_unadj <- with(
  data = stopvape.mice,
  expr = coxph(Surv(Time.elapsed, status) ~ ecusv_3,
               cluster = stopvape.pooled$userid,
               subset = (gender_adj == "Men"))
)
pooled_men_unadj <- pool(cox_mi_men_unadj)

# Women adjusted
cox_mi_women_unadj <- with(
  data = stopvape.mice,
  expr = coxph(Surv(Time.elapsed, status) ~ ecusv_3,
               cluster = stopvape.pooled$userid,
               subset = (gender_adj == "Women"))
)
pooled_women_unadj <- pool(cox_mi_women_unadj)

# others unadjusted 
cox_mi_others_unadj <- with(
  data = stopvape.mice,
  expr = coxph(Surv(Time.elapsed, status) ~ ecusv_3,
               cluster = stopvape.pooled$userid,
               subset = (gender_adj == "Others"))
)
pooled_others_unadj <- pool(cox_mi_others_unadj)
  
# Men adjusted
cox_mi_men <- with(
  data = stopvape.mice,
  expr = coxph(Surv(Time.elapsed, status) ~ ecusv_3 + age + country + sexorient_adj + race + ecu17_1 + ecusv_2 + mhealth1_1,
               cluster = stopvape.pooled$userid,
               subset = (gender_adj == "Men"))
)
pooled_men <- pool(cox_mi_men)
# Women adjusted
cox_mi_women <- with(
  data = stopvape.mice,
  expr = coxph(Surv(Time.elapsed, status) ~ ecusv_3 + age + country + sexorient_adj + race + ecu17_1 + ecusv_2 + mhealth1_1,
               cluster = stopvape.pooled$userid,
               subset = (gender_adj == "Women"))
)
pooled_women <- pool(cox_mi_women)
# Others
cox_mi_others <- with(
  data = stopvape.mice,
  expr = coxph(Surv(Time.elapsed, status) ~ ecusv_3 + age + country + sexorient_adj + race + ecu17_1 + ecusv_2 + mhealth1_1,
               cluster = stopvape.pooled$userid,
               subset = (gender_adj == "Others"))
)
pooled_others <- pool(cox_mi_others)


summary(pooled_men_unadj, conf.int = TRUE, exponentiate = TRUE)
summary(pooled_women_unadj, conf.int = TRUE, exponentiate = TRUE)
summary(pooled_others_unadj, conf.int = TRUE, exponentiate = TRUE)

summary(pooled_men, conf.int = TRUE, exponentiate = TRUE)
summary(pooled_women, conf.int = TRUE, exponentiate = TRUE)
summary(pooled_others, conf.int = TRUE, exponentiate = TRUE)
```

# Univariable Kaplan-Meier curve of vaping relapse survival by quitting confidence levels (low, medium, high)

```{r}

#split into groups low, medium, high quitting confidence 
stopvape.pooled$conf_group <- cut(stopvape.pooled$ecusv_3,
                           breaks = c(0, 5, 10),
                           labels = c("Low", "High"),
                           right = TRUE)

surv_elapsed <- Surv(time = stopvape.pooled$Time.elapsed, 
                 event = stopvape.pooled$status)
relapse.km <- npsurv(surv_elapsed ~ conf_group, data = stopvape.pooled)
survplotp(relapse.km, 
          conf.int = TRUE, 
          col = c("red", "blue"), 
          lty = 1:2,
          xlim = c(0,45),
          time.inc = 2,
          xlab = "Time Elapsed",
          ylab = "Proportion Remaining Vape-Free",
          main = "Survival by Confidence in Quitting (Low vs High)")


#median survival time for each quitting confidence level 1-10
survfit(Surv(Time.elapsed,status)~ecusv_3, data = stopvape.pooled)
survfit(surv_elapsed ~ conf_group, data = stopvape.pooled)


# Separate data by sex (adjust variable name if needed)
stopvape_male <- stopvape.pooled[stopvape.pooled$gender_adj == "Men", ]  # or whatever the male category is
stopvape_female <-stopvape.pooled[stopvape.pooled$gender_adj == "Women", ]
stopvape_others <- stopvape.pooled[stopvape.pooled$gender_adj == "Others", ]

surv_male <- Surv(time = stopvape_male$Time.elapsed, event = stopvape_male$status)
surv_female <- Surv(time = stopvape_female$Time.elapsed, event = stopvape_female$status)
surv_others <- Surv(time = stopvape_others$Time.elapsed, event = stopvape_others$status)

relapse.km.male <- npsurv(surv_male ~ conf_group, data = stopvape_male)
relapse.km.female <- npsurv(surv_female ~ conf_group, data = stopvape_female)
relapse.km.others <- npsurv(surv_others~ conf_group, data = stopvape_others)

# Create side-by-side plots
par(mfrow = c(1, 2))

survplotp(relapse.km.male, 
          conf.int = TRUE, 
          col = c("red", "blue"), 
          lty = 1:2,
          xlim = c(0,30),
          time.inc = 2,
          xlab = "Time Elapsed for Men",
          ylab = "Proportion Remaining Vape-Free",
          main = "Survival by Confidence - Men")

survplotp(relapse.km.female, 
          conf.int = TRUE, 
          col = c("red", "blue"), 
          lty = 1:2,
          xlim = c(0,30),
          time.inc = 2,
          xlab = "Time Elapsed for Women",
          ylab = "Proportion Remaining Vape-Free",
          main = "Survival by Confidence - Women")

survplotp(relapse.km.others, 
          conf.int = TRUE, 
          col = c("red", "blue"), 
          lty = 1:2,
          xlim = c(0,30),
          time.inc = 2,
          xlab = "Time Elapsed for Others",
          ylab = "Proportion Remaining Vape-Free",
          main = "Survival by Confidence - Others")
```
### log-rank MH test â†’ highly significant difference between the survival curves of the groups
```{r}
#log-rank MH test 
#compute the test of the difference between the survival curves
sur.mh <- survdiff(surv_elapsed ~ conf_group, data = stopvape)
sur.mh 

```
# fitting conceptual model using PH cox model 

```{r}
# #covariates:self confidence to quit,intention to quit at baseline,number quit attempts, perceived mh
# fit1.cox <- coxph(surv_elapsed~ecusv_3,data=stopvape)
# fit2.cox <- coxph(surv_elapsed~ecusv_3+age+country+gender_adj+sexorient_adj+race+ecu17_1+ecusv_2+mhealth1_1,data=stopvape)
# fit3.cox <- coxph(surv_elapsed~ecusv_3+age+strat(gender_adj)+sexorient_adj+race+ecu17_1+ecusv_2+mhealth1_1,data=stopvape)
# 
# #anova wald test
# anova(fit2.cox) 
# 
# #HR + 95% CI for each covariate
# exp(fit2.cox$coefficients)
# exp(confint(fit2.cox))
# 
# exp(fit3.cox$coefficients)
# exp(confint(fit3.cox))
# 
# #km curve with all covariates
# survplot(npsurv(surv_elapsed ~ ecusv_3+age+country+gender+sexorient+race+ecu17_1+ecusv_2+mhealth1_1, data=stopvape), conf = 'none')
# 
# #lrt significant
# lrtest(fit1.cox,fit3.cox)


```



# Model diagnostics

```{r}
stopvape.dd <- datadist(stopvape)
options(datadist="stopvape.dd")


fit2 <- cph(surv_elapsed~ecusv_3+age+country+gender_adj+sexorient_adj+race+ecu17_1+ecusv_2+mhealth1_1,data=stopvape.pooled, x = TRUE, y = TRUE)
#Testing PH assumption

fit2.zph <-  cox.zph(fit2)
plot(fit2.zph)
# for each covariate, graphs of the scaled Schoenfeld residuals against the transformed time
ggcoxzph(fit2.zph)


# martingale residuals
res <- resid(fit2, "martingale") #presented the lowest values for the martingale residual.
head(sort(res))
res.dev<- resid(fit2,type="deviance") #presented the highest absolute value.
head(sort(abs(res.dev),decreasing = TRUE))

res.lo <- loess(res~ecusv_3,data=stopvape.pooled)
res.ols <- ols(res~ecusv_3,data=stopvape.pooled)

ggplot(data=stopvape.pooled, aes(x=ecusv_3, y=res))+
  geom_point(pch=1)+
  geom_smooth(method="loess")+
  geom_line(aes(y=predict(res.ols)),col="red", linewidth=1)+
  xlab("ecusv_3")+
  ylab("Martingale Residual")+
  theme_bw()

#score residuals
fit.res <- resid(fit2 ,type="score")
fit.res


ggplot(data=stopvape.pooled, aes(y=fit.res[,"ecusv_3"], x=ecusv_3))+
        geom_point(pch=1, size=2)+
        xlab("self-confidence")+
        ylab("Score Residual")+
        theme_bw()


#finding outliers
fit.dfbetas <- resid(fit2.cox, type="dfbetas")
fit.dfbetas
boxplot(fit.dfbetas)

show.influence(which.influence(fit2),stopvape.pooled)

### VIF
vif(fit2)

### Bootstrap model validation
set.seed(456)
validate(fit2,method=".632",B=100)


```

